<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Teacher Export â€” Landscape</title>
<style>
body{font-family:Arial;background:#0b1220;color:#fff;padding:40px;max-width:900px;margin:auto}
input,button{padding:10px 12px;border-radius:10px;border:none;font-size:16px}
button{cursor:pointer;font-weight:700;margin-left:10px}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:18px;margin-top:14px}
#panel{display:none}
small{opacity:.8}
</style>
</head>
<body>

<h2>Teacher Export Panel</h2>
<div class="card">
  <input type="password" id="pass" placeholder="Passcode">
  <button id="unlock">Unlock</button>
  <div><small>Keep this private.</small></div>
</div>

<div class="card" id="panel">
  <button id="download">Download CSV (Excel)</button>
  <p id="status"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyjHGKmWqtvRn6ikJxWQeCAocbGIZqS3Y",
  authDomain: "mmmm-7a485.firebaseapp.com",
  projectId: "mmmm-7a485",
  storageBucket: "mmmm-7a485.firebasestorage.app",
  messagingSenderId: "177735973547",
  appId: "1:177735973547:web:0d9ea6f476b886ab6195ee"
};

const PASSCODE = "FPL2026"; // change this
const COLLECTION = "submissions_g6_social_landscape_01";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const panel = document.getElementById("panel");
const statusEl = document.getElementById("status");

document.getElementById("unlock").onclick = () => {
  if (document.getElementById("pass").value === PASSCODE) panel.style.display = "block";
  else alert("Incorrect passcode");
};

document.getElementById("download").onclick = async () => {
  statusEl.textContent = "Loading...";
  const qy = query(collection(db, COLLECTION), orderBy("createdAt", "asc"));
  const snap = await getDocs(qy);

  const rows = [];
  rows.push(["firstName","secondName","fullName","q1","q2","q3","q4","q5","q6","q7","q8","q9","q10","timestamp","language"]);

  snap.forEach(doc => {
    const d = doc.data();
    rows.push([
      safe(d.firstName), safe(d.secondName), safe(d.fullName),
      safe(d.q1), safe(d.q2), safe(d.q3), safe(d.q4), safe(d.q5),
      safe(d.q6), safe(d.q7), safe(d.q8), safe(d.q9), safe(d.q10),
      safe(d.timestamp), safe(d.language)
    ]);
  });

  const csv = rows.map(r => r.map(csvCell).join(",")).join("\n");
  downloadFile(`${COLLECTION}.csv`, csv);
  statusEl.textContent = `Downloaded ${snap.size} submissions.`;
};

function safe(v){ return (v ?? "").toString().trim(); }
function csvCell(s){
  const needs = /[,"\n]/.test(s);
  const escaped = s.replace(/"/g, '""');
  return needs ? `"${escaped}"` : escaped;
}
function downloadFile(filename, text){
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
</script>

</body>
</html>
